<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Blue Lock 2D - Skills, Zagueiros e IA Melhorada</title>
  <style>
    body {
      margin: 0;
      background: #113377;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #fff;
      font-family: Arial, sans-serif;
    }
    h1 {
      margin-top: 24px;
    }
    #container {
      margin-top: 24px;
      background: #222;
      border-radius: 10px;
      box-shadow: 0 8px 32px #0006;
      padding: 1rem 2rem 2rem 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      background: #60b347;
      border: 4px solid #222;
      border-radius: 10px;
      margin-bottom: 1rem;
      display: block;
    }
    #scoreboard {
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    #instructions {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: #eee;
    }
    .skills {
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
    }
    .skills button, #dribbleBtn {
      padding: 0.5rem 1.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 7px;
      background: #00bfff;
      color: #153e6b;
      cursor: pointer;
      font-weight: bold;
      transition: background .2s, color .2s;
    }
    .skills button.active {
      background: #ffe600;
      color: #222;
    }
    .skills button:active, #dribbleBtn:active {
      background: #1e90ff;
      color: #fff;
    }
    #restart {
      display: none;
      padding: 0.5rem 1.5rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 7px;
      background: #00bfff;
      color: #153e6b;
      cursor: pointer;
      margin-top: 1rem;
      transition: background .2s;
    }
    #restart:hover {
      background: #1e90ff;
    }
    #dribbleBtn {
      display: none;
      margin-bottom: 1rem;
      background: #ffe600;
      color: #191970;
      font-weight: bold;
      border: 2px solid #153e6b;
      box-shadow: 0 0 8px #fff70080;
      animation: dribblePulse 1s infinite alternate;
    }
    @keyframes dribblePulse {
      0% { box-shadow: 0 0 8px #ffe60080; }
      100% { box-shadow: 0 0 18px #ffe600cc; }
    }
    .keyhint {
      font-size: 0.9em;
      color: #ffe600;
      background: #242424;
      border-radius: 5px;
      padding: 2px 7px;
      margin-left: 0.3em;
      margin-right: 0.3em;
      font-weight: bold;
      letter-spacing: 1px;
      border: 1.5px solid #ffe60090;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h1>Blue Lock 2D - Skills, Zagueiros e IA Melhorada</h1>
  <div id="container">
    <div id="scoreboard"></div>
    <div id="instructions">
      Mova-se com as <b>setas</b>. <b>Espa√ßo</b> para chutar!<br>
      Skills: <span class="keyhint">Z</span> Kaiser Impact | <span class="keyhint">X</span> Chute Curvo | <span class="keyhint">Q</span> Drible<br>
      Ative skills antes de chutar, drible apenas quando aparecer o bot√£o!
    </div>
    <div class="skills">
      <button id="kaiserBtn">Kaiser Impact ‚ö° <span class="keyhint">Z</span></button>
      <button id="curvoBtn">Chute Curvo üåÄ <span class="keyhint">X</span></button>
    </div>
    <button id="dribbleBtn">Driblar! <span class="keyhint">Q</span></button>
    <canvas id="game" width="500" height="320"></canvas>
    <button id="restart">Jogar Novamente</button>
  </div>
  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreboard = document.getElementById('scoreboard');
    const restartBtn = document.getElementById('restart');
    const kaiserBtn = document.getElementById('kaiserBtn');
    const curvoBtn = document.getElementById('curvoBtn');
    const dribbleBtn = document.getElementById('dribbleBtn');

    // Campo
    const field = {
      width: 500,
      height: 320,
      goal: {x: 200, y: 10, w: 100, h: 15}
    };

    // Estado do jogo
    let player, ball, goalie, defenders;
    let score = 0;
    let chances = 3;
    let gameState = 'playing'; // 'playing', 'goal', 'miss', 'over', 'dribble'
    let dribbleWindow = false;
    let dribbleSuccess = false;
    let dribbleFailTimeout = null;

    // Skills
    let kaiserActive = false;
    let curvoActive = false;

    function resetPositions() {
      player = {x: field.width/2, y: field.height-50, r: 16, speed: 3};
      ball = {
        x: player.x,
        y: player.y - 18,
        r: 8,
        speed: 5,
        vx: 0, vy: 0,
        moving: false,
        curveT: 0,
        curveMaxT: 60,
        curveDir: 0,
        curving: false
      };
      goalie = {
        x: field.width/2 + Math.random() * 30 - 15,
        y: 28,
        r: 18,
        speed: 2.5,
        dir: 1,  // dire√ß√£o inicial, IA melhorada ajusta isso
        reaction: 0.23 + Math.random()*0.16 // aleat√≥rio, para n√£o ficar imposs√≠vel
      };
      defenders = [
        {
          x: field.goal.x + 30,
          y: 110,
          r: 16,
          speed: 2.2 + Math.random()*0.5,
        },
        {
          x: field.goal.x + field.goal.w - 30,
          y: 160,
          r: 16,
          speed: 2.2 + Math.random()*0.5,
        }
      ];
      dribbleWindow = false;
      dribbleSuccess = false;
      clearTimeout(dribbleFailTimeout);
      dribbleBtn.style.display = "none";
    }

    function drawField() {
      ctx.fillStyle = '#60b347';
      ctx.fillRect(0, 0, field.width, field.height);
      ctx.fillStyle = '#fff';
      ctx.fillRect(field.goal.x, field.goal.y, field.goal.w, field.goal.h);
      ctx.strokeStyle = '#fff';
      ctx.strokeRect(field.goal.x, field.goal.y, field.goal.w, 28);
      ctx.strokeRect(field.goal.x - 40, field.goal.y + 15, field.goal.w + 80, 55);
      ctx.strokeStyle = '#fff8';
      ctx.beginPath();
      ctx.moveTo(0, field.height / 2);
      ctx.lineTo(field.width, field.height / 2);
      ctx.stroke();
    }

    function drawPlayer() {
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.r, 0, 2 * Math.PI);
      ctx.fillStyle = '#2196f3';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(player.x, player.y - 9, 6, 0, 2 * Math.PI);
      ctx.fillStyle = '#42a5f5';
      ctx.fill();
    }

    function drawBall() {
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.r, 0, 2 * Math.PI);
      ctx.fillStyle = '#fff';
      ctx.fill();
      ctx.strokeStyle = '#222';
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(ball.x + 2, ball.y + 2, 2.5, 0, 2 * Math.PI);
      ctx.fillStyle = '#ccc';
      ctx.fill();
      // Skills visual
      if (kaiserActive && ball.moving) {
        ctx.save();
        ctx.globalAlpha = 0.5;
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.r+7, 0, 2*Math.PI);
        ctx.strokeStyle = '#ffe600';
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.restore();
      }
      if (curvoActive && ball.moving) {
        ctx.save();
        ctx.globalAlpha = 0.45;
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.r+10, 0, 2*Math.PI);
        ctx.strokeStyle = '#00eaff';
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.restore();
      }
    }

    function drawGoalie() {
      ctx.beginPath();
      ctx.arc(goalie.x, goalie.y, goalie.r, 0, 2 * Math.PI);
      ctx.fillStyle = '#d32f2f';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(goalie.x, goalie.y - 9, 6, 0, 2 * Math.PI);
      ctx.fillStyle = '#ef5350';
      ctx.fill();
    }

    function drawDefenders() {
      defenders.forEach(def => {
        ctx.beginPath();
        ctx.arc(def.x, def.y, def.r, 0, 2 * Math.PI);
        ctx.fillStyle = '#f7b731';
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(def.x, def.y - 8, 5, 0, 2 * Math.PI);
        ctx.fillStyle = '#e67e22';
        ctx.fill();
      });
      ctx.lineWidth = 1;
    }

    // IA do goleiro melhorada: segue a bola s√≥ se ela estiver vindo, reage ao chute, e "salta" para interceptar a bola
    function updateGoalie() {
      // Quando a bola est√° chutada, o goleiro tenta ir para a trajet√≥ria do chute com leve atraso/rea√ß√£o
      if (ball.moving) {
        // O goleiro tenta prever onde a bola cruzar√° a linha do gol
        // Calcula a posi√ß√£o X onde a bola cruzar√° y = field.goal.y + field.goal.h
        let t = (field.goal.y + field.goal.h - ball.y) / ball.vy;
        let interceptX = ball.x + ball.vx * t;
        // Se a bola est√° indo para baixo ou j√° passou do gol, fica parado
        if (t < 0 || isNaN(t) || !isFinite(t)) {
          // nada
        } else {
          // Move em dire√ß√£o ao interceptX, com velocidade e rea√ß√£o
          let diff = interceptX - goalie.x;
          goalie.x += diff * goalie.reaction;
          // Limites do gol
          if (goalie.x - goalie.r < field.goal.x) goalie.x = field.goal.x + goalie.r;
          if (goalie.x + goalie.r > field.goal.x + field.goal.w) goalie.x = field.goal.x + field.goal.w - goalie.r;
        }
      } else {
        // Antes do chute, o goleiro tenta acompanhar horizontalmente o jogador, mas com atraso
        let diff = player.x - goalie.x;
        goalie.x += diff * 0.07;
        // Limites do gol
        if (goalie.x - goalie.r < field.goal.x) goalie.x = field.goal.x + goalie.r;
        if (goalie.x + goalie.r > field.goal.x + field.goal.w) goalie.x = field.goal.x + field.goal.w - goalie.r;
      }
    }

    // Zagueiros agora perseguem o jogador
    function updateDefenders() {
      defenders.forEach(def => {
        // S√≥ perseguem se o jogador n√£o chutou ainda
        if (!ball.moving && !dribbleWindow) {
          // Move na dire√ß√£o do jogador com uma pequena aleatoriedade
          let dx = player.x - def.x;
          let dy = player.y - def.y;
          let dist = Math.sqrt(dx*dx + dy*dy);
          // Para n√£o tremular quando muito pr√≥ximo, s√≥ move se estiver longe
          if (dist > 1) {
            let normX = dx / dist;
            let normY = dy / dist;
            // Pequena aleatoriedade para n√£o ficarem iguais
            let rand = (Math.random()-0.5)*0.3;
            def.x += (normX + rand) * def.speed;
            def.y += (normY + rand) * def.speed;
          }
          // Limites verticais para os zagueiros (ficam entre √°rea e meio campo)
          if (def.y < 85) def.y = 85;
          if (def.y > field.height-60) def.y = field.height-60;
          // Limites horizontais do campo
          if (def.x - def.r < 10) def.x = 10 + def.r;
          if (def.x + def.r > field.width-10) def.x = field.width-10 - def.r;
        }
      });
    }

    // Movimenta√ß√£o
    let keys = {};
    document.addEventListener('keydown', e => {
      // Atalhos para skills (z/x) e drible (q)
      if (e.key === 'z' || e.key === 'Z') {
        e.preventDefault();
        if (!ball.moving && gameState === "playing" && !dribbleWindow) {
          kaiserActive = !kaiserActive;
          kaiserBtn.classList.toggle('active', kaiserActive);
        }
      } else if (e.key === 'x' || e.key === 'X') {
        e.preventDefault();
        if (!ball.moving && gameState === "playing" && !dribbleWindow) {
          curvoActive = !curvoActive;
          curvoBtn.classList.toggle('active', curvoActive);
        }
      } else if ((e.key === 'q' || e.key === 'Q') && dribbleWindow && !dribbleSuccess) {
        e.preventDefault();
        triggerDribble();
      }
      else if (gameState === 'playing' && !dribbleWindow) {
        keys[e.key] = true;
        if (e.key === ' ' && !ball.moving) {
          kickBall();
        }
      }
    });
    document.addEventListener('keyup', e => {
      keys[e.key] = false;
    });

    function updatePlayer() {
      if (ball.moving || dribbleWindow) return;
      if (keys['ArrowLeft'] && player.x - player.r > 0) player.x -= player.speed;
      if (keys['ArrowRight'] && player.x + player.r < field.width) player.x += player.speed;
      if (keys['ArrowUp'] && player.y - player.r > 80) player.y -= player.speed;
      if (keys['ArrowDown'] && player.y + player.r < field.height) player.y += player.speed;
      ball.x = player.x;
      ball.y = player.y - player.r - ball.r - 2;
    }

    function kickBall() {
      let speedMult = 1;
      if (kaiserActive) speedMult = 2.3;
      let isCurvo = curvoActive;
      const targetX = field.goal.x + field.goal.w/2 + (Math.random()-0.5)*55;
      const targetY = field.goal.y + field.goal.h + 5;
      const dx = targetX - ball.x;
      const dy = targetY - ball.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      ball.vx = ball.speed * speedMult * dx / dist;
      ball.vy = ball.speed * speedMult * dy / dist;
      ball.moving = true;
      if (isCurvo) {
        ball.curving = true;
        ball.curveT = 0;
        ball.curveDir = Math.random() > 0.5 ? 1 : -1;
      } else {
        ball.curving = false;
      }
      kaiserActive = false;
      curvoActive = false;
      kaiserBtn.classList.remove('active');
      curvoBtn.classList.remove('active');
    }

    function updateBall() {
      if (!ball.moving) return;
      if (ball.curving && ball.curveT < ball.curveMaxT) {
        const curveStrength = 2.1 * ball.curveDir * Math.sin(Math.PI * ball.curveT / ball.curveMaxT);
        ball.vx += curveStrength * 0.05;
        ball.curveT++;
      }
      ball.x += ball.vx;
      ball.y += ball.vy;
      // Colis√£o com goleiro
      const distGoalie = Math.hypot(ball.x - goalie.x, ball.y - goalie.y);
      if (distGoalie < ball.r + goalie.r) {
        gameState = 'miss';
        chances--;
        showResult('Defendido pelo goleiro! üò±');
        return;
      }
      // Gol
      if (
        ball.y - ball.r <= field.goal.y + field.goal.h &&
        ball.x >= field.goal.x &&
        ball.x <= field.goal.x + field.goal.w
      ) {
        gameState = 'goal';
        score++;
        showResult('GOOOOL! ‚öΩÔ∏è');
        return;
      }
      // Fora do campo
      if (ball.y < 0 || ball.x < 0 || ball.x > field.width) {
        gameState = 'miss';
        chances--;
        showResult('Voc√™ errou o gol! üòì');
        return;
      }
    }

    function checkDefenderCollision() {
      if (ball.moving || dribbleWindow) return;
      for (let def of defenders) {
        const dist = Math.hypot(player.x - def.x, player.y - def.y);
        if (dist < player.r + def.r + 6) {
          // Drible ativado!
          dribbleWindow = true;
          dribbleSuccess = false;
          dribbleBtn.style.display = "inline-block";
          gameState = "dribble";
          // Tempo para reagir
          dribbleFailTimeout = setTimeout(() => {
            if (!dribbleSuccess) {
              dribbleBtn.style.display = "none";
              gameState = "miss";
              chances--;
              showResult('O zagueiro roubou a bola! üòµ');
            }
          }, 1100);
          break;
        }
      }
    }

    function triggerDribble() {
      if (dribbleWindow && !dribbleSuccess) {
        dribbleSuccess = true;
        dribbleWindow = false;
        gameState = "playing";
        dribbleBtn.style.display = "none";
        clearTimeout(dribbleFailTimeout);
        // Efeito visual de drible (r√°pido avan√ßo)
        player.y -= 24;
        if (player.y < 80 + player.r) player.y = 80 + player.r + 2;
      }
    }

    dribbleBtn.onclick = triggerDribble;

    function showResult(msg) {
      setTimeout(() => {
        if (chances === 0) {
          gameState = 'over';
          draw();
          scoreboard.innerHTML = `<b>Fim de jogo!</b> Gols: ${score}<br>` +
            (score >= 3
              ? "Voc√™ √© digno do Blue Lock! üèÜ"
              : "Continue treinando para ser o melhor!");
          restartBtn.style.display = 'block';
        } else {
          scoreboard.innerHTML = msg + `<br>Gols: ${score} | Chances restantes: ${chances}`;
          resetPositions();
          setTimeout(() => {
            scoreboard.innerHTML = `Gols: ${score} | Chances restantes: ${chances}`;
            gameState = 'playing';
          }, 1200);
        }
      }, 700);
    }

    function draw() {
      drawField();
      drawDefenders();
      drawGoalie();
      drawPlayer();
      drawBall();
    }

    function gameLoop() {
      if (gameState === 'playing') {
        updatePlayer();
        updateGoalie();
        updateDefenders();
        updateBall();
        checkDefenderCollision();
        scoreboard.innerHTML = `Gols: ${score} | Chances restantes: ${chances}`;
      }
      if (gameState === 'dribble') {
        updateGoalie();
        updateDefenders();
        draw();
        scoreboard.innerHTML = `Drible! Pressione <span class="keyhint">Q</span> ou clique no bot√£o para driblar o zagueiro!<br>Gols: ${score} | Chances restantes: ${chances}`;
      } else {
        draw();
      }
      if (gameState !== 'over') {
        requestAnimationFrame(gameLoop);
      }
    }

    restartBtn.onclick = () => {
      score = 0;
      chances = 3;
      gameState = 'playing';
      restartBtn.style.display = 'none';
      resetPositions();
      gameLoop();
    };

    // Skills UI
    kaiserBtn.onclick = () => {
      if (!ball.moving && gameState === "playing" && !dribbleWindow) {
        kaiserActive = !kaiserActive;
        kaiserBtn.classList.toggle('active', kaiserActive);
      }
    };
    curvoBtn.onclick = () => {
      if (!ball.moving && gameState === "playing" && !dribbleWindow) {
        curvoActive = !curvoActive;
        curvoBtn.classList.toggle('active', curvoActive);
      }
    };

    // Inicializa
    resetPositions();
    gameLoop();
  </script>
</body>
</html>
